<!DOCTYPE html>
<html>

<head>
  <script src="../node_modules/ace-builds/src-min-noconflict/ace.js"></script>
  <script src="../node_modules/ace-builds/src-min-noconflict/ext-language_tools.js"></script>
  <script src="../node_modules/sql-formatter/dist/sql-formatter.min.js"></script>
  <script src="PrestoSqlMode.js"></script>
  <script src="../dist/ace-ts-editor.js"></script>
</head>

<body>
  <script>
    window.onload = function () {
      /**
       * Mock schema API call with delay.
       */
      function fetchSchemaMock() {
        return new Promise((resolve, reject) => {
          try {
            setTimeout(() => resolve(['customer', 'customeraddress', 'tenantentity']), 200);
          } catch (e) {
            reject(e);
          }
        });
      }

      /**
       * Transform suggested keywords in upper case.
       */
      function getUpperCaseCompleter() {
        return {
          getCompletions: (editor, session, pos, prefix, callback) => {
            var state = editor.session.getState(pos.row);
            var keywordCompletions = session.$mode.getCompletions(state, session, pos, prefix);
            keywordCompletions = keywordCompletions.map((obj) => {
              return Object.assign(obj, { value: obj.value.toUpperCase() });
            });
            return callback(null, keywordCompletions);
          }
        }
      }

      /**
       * Analytics schema derived completer which suggests exported tables and columns.
       */
      function getSchemaCompleter(schema) {
      // TODO: refactor schema into data structure { table: {name: string, columns: string[]}}[]
        return {
          getCompletions: (editor, session, pos, prefix, callback) => {
            var schemaCompletions = schema.map((t) => ({ meta: 'schema', value: t, score: 10 }));
            return callback(null, schemaCompletions);
          }
        }
      }

    /**
     * Existing ace completer for recognizing existing tokens within the editor.
     */
    function getTextCompleter() {
      return ace.require('ace/ext/language_tools').textCompleter;
    }
        }
      }

      /**
       * config
       */
      var element = document.querySelector('body > #editor');
      var cfg = {
        element,
        value: `SELECT t.id, t.name, t.amount FROM transactions t WHERE t.id > 5000`,
        options: {
          mode: 'ace/mode/prestosql',
          theme: 'ace/theme/eclipse',
          enableBasicAutocompletion: true,
          enableLiveAutocompletion: false,
          minLines: 25,
          maxLines: 50,
          showPrintMargin: false
        },
        completers: []
      };

      var aceEditor;

      var completers = [];
      fetchSchemaMock().then((res) => {
        completers = [
          getUpperCaseCompleter(),
          getSchemaCompleter(res),
          getTextCompleter()
        ];
        Object.assign(cfg, { completers });
        aceEditor = new AceTsEditor.AceEditor(cfg);
      });

      document.querySelector('body > #format').onclick = function (evt) {
        var editor = ace.edit("editor");
        var value = editor.getValue();
        var formatted = sqlFormatter.format(value, { language: 'sql' });
        editor.setValue(formatted);
        editor.clearSelection();
      }
    }
  </script>
  <div id="editor"></div>
  <button id="format">Format</button>
</body>

</html>
